const BATCH_SIZE = 1000;
let lastId = null;

while (true) {
  // Step 1: Get next batch of COMPLETED masterIds from collection1
  const query = lastId ? { status: "COMPLETED", _id: { $gt: lastId } } : { status: "COMPLETED" };
  const masterIdBatch = db.collection1
    .find(query)
    .sort({ _id: 1 })
    .limit(BATCH_SIZE)
    .map(doc => {
      lastId = doc._id;
      return doc.masterId;
    });

  if (masterIdBatch.length === 0) {
    print("Finished processing all batches.");
    break;
  }

  // Step 2: Find matching docs in collection2
  const docsToMove = db.collection2.find({ masterId: { $in: masterIdBatch } }).toArray();

  if (docsToMove.length > 0) {
    // Step 3: Insert into target collection
    db.targetCollection.insertMany(docsToMove);

    // Step 4: Delete from collection2
    db.collection2.deleteMany({ masterId: { $in: masterIdBatch } });
  }

  print("Processed batch with masterIds count:", masterIdBatch.length);
}
