const BATCH_SIZE = 500;
let skip = 0;
let batch = [];

while (true) {
  batch = db.automation
    .find({}, { _id: 1 }) // only fetch _id
    .skip(skip)
    .limit(BATCH_SIZE)
    .toArray();

  if (batch.length === 0) break;

  const batchIds = batch.map(doc => doc._id);

  // Find which of those exist in masterId collection
  const existingIds = new Set(
    db.masterId.find({ _id: { $in: batchIds } }, { _id: 1 })
      .map(doc => doc._id.valueOf())
  );

  // Find missing ones
  const missingIds = batchIds.filter(
    id => !existingIds.has(id.valueOf())
  );

  if (missingIds.length > 0) {
    // Update all missing IDs in automation
    db.automation.updateMany(
      { _id: { $in: missingIds } },
      {
        $set: {
          status: "FAILED",
          message: "failed due to not present"
        }
      }
    );
  }

  print(`Processed batch of ${batch.length}, updated ${missingIds.length} documents.`);

  skip += BATCH_SIZE;
}
