// Dynamically provided variables
String mapDefId = "99";  // Example value for mapDefId
String masterId = "12";  // Example value for masterId
List<String> selectionAttributes = Arrays.asList("cdsid", "mpsid");  // Example selection attributes (could be dynamic)
List<String> groupingAttributes = Arrays.asList("line1", "line2");  // Example grouping attributes (could be dynamic)

List<Bson> aggregationPipeline = Arrays.asList(
    // Match documents based on mapDefId and masterId in Collection 1
    Aggregates.match(Filters.and(
        Filters.eq("mapDefId", mapDefId),
        Filters.eq("masterId", masterId)
    )),
    
    // Unwind delta.input array to flatten the values in delta object
    Aggregates.unwind("$delta.input", true),
    
    // Unwind snapshot.input array to flatten the values in snapshot object
    Aggregates.unwind("$snapshot.input", true),
    
    // Add fields for dynamic selection and grouping attributes
    Aggregates.addFields(
        // For each selection attribute, try to pick the value from delta first and then snapshot
        selectionAttributes.stream().map(attr -> {
            return new Field<>(attr, Filters.or(
                Filters.eq("delta.input.name", attr), 
                Filters.eq("snapshot.input.name", attr)
            ));
        }).toArray(Field[]::new)
    ),
    
    // Perform the lookup to join with Collection 2 based on seq and mapDefId
    Aggregates.lookup(
        "collection2",  // Collection 2 name
        Arrays.asList("seq", "mapDefId"),  // Join on seq and mapDefId
        Arrays.asList("seq", "mapDefId"),
        "joined_docs"
    ),
    
    // Unwind the joined documents from Collection 2
    Aggregates.unwind("$joined_docs", true),
    
    // Group by the dynamic grouping attributes
    Aggregates.group(
        new Document(groupingAttributes.stream()
            .collect(Collectors.toMap(
                attribute -> attribute, 
                attribute -> "$" + attribute
            ))
        ), 
        Accumulators.addToSet("groupingAttributesValues", "$line1"),  // Collect distinct line1 values
        Accumulators.addToSet("groupingAttributesValues", "$line2")   // Collect distinct line2 values
    ),
    
    // Match to filter groups with more than 3 distinct line values
    Aggregates.match(Filters.gt(new Document("groupingAttributesValues", new Document("$size", 3))))
);

